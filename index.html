}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    addExperience();
    addEducation();
    
    // Setup drag and drop
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
});

// CV Import Functions
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        handleFile(file);
    }
}

function handleFile(file) {
    if (!file.name.endsWith('.docx')) {
        alert('Please upload a Word document (.docx file)');
        return;
    }
    
    // Show parsing status
    const statusDiv = document.getElementById('parsingStatus');
    const statusMessages = document.getElementById('statusMessages');
    const progressFill = document.getElementById('progressFill');
    
    statusDiv.classList.add('active');
    statusMessages.innerHTML = '';
    progressFill.style.width = '0%';
    
    addStatusMessage('Reading document...', 'processing');
    progressFill.style.width = '20%';
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const arrayBuffer = e.target.result;
        
        addStatusMessage('Extracting text...', 'processing');
        progressFill.style.width = '40%';
        
        mammoth.extractRawText({arrayBuffer: arrayBuffer})
            .then(result => {
                const text = result.value;
                
                addStatusMessage('Parsing CV content...', 'processing');
                progressFill.style.width = '60%';
                
                // Parse the CV
                setTimeout(() => {
                    const parsedData = parseCV(text);
                    importedData = parsedData;
                    
                    addStatusMessage('Extraction complete!', 'success');
                    progressFill.style.width = '100%';
                    
                    // Display extracted data
                    displayExtractedData(parsedData);
                    
                    setTimeout(() => {
                        statusDiv.classList.remove('active');
                    }, 2000);
                }, 500);
            })
            .catch(err => {
                console.error(err);
                addStatusMessage('Error reading document. Please try another file.', 'error');
            });
    };
    
    reader.readAsArrayBuffer(file);
}

function addStatusMessage(message, type = 'success') {
    const statusMessages = document.getElementById('statusMessages');
    const iconMap = {
        success: 'fa-check-circle',
        processing: 'fa-spinner fa-spin',
        error: 'fa-exclamation-circle'
    };
    
    const statusItem = document.createElement('div');
    statusItem.className = `status-item ${type}`;
    statusItem.innerHTML = `
        <i class="fas ${iconMap[type]}"></i>
        <span>${message}</span>
    `;
    statusMessages.appendChild(statusItem);
}

function parseCV(text) {
    const data = {
        fullName: '',
        jobTitle: '',
        email: '',
        phone: '',
        linkedin: '',
        github: '',
        website: '',
        location: '',
        summary: '',
        skills: [],
        experiences: [],
        education: [],
        certifications: [],
        languages: []
    };
    
    // Split into lines for easier parsing
    const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    
    // Extract email
    const emailMatch = text.match(/[\w\.-]+@[\w\.-]+\.\w+/);
    if (emailMatch) data.email = emailMatch[0];
    
    // Extract phone
    const phoneMatch = text.match(/[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,4}[-\s\.]?[0-9]{1,9}/);
    if (phoneMatch) data.phone = phoneMatch[0];
    
    // Extract LinkedIn
    const linkedinMatch = text.match(/(?:linkedin\.com\/in\/|linkedin\.com\/profile\/)[\w\-]+|(?:https?:\/\/)?(?:www\.)?linkedin\.com\/in\/[\w\-]+/i);
    if (linkedinMatch) data.linkedin = linkedinMatch[0].startsWith('http') ? linkedinMatch[0] : 'https://' + linkedinMatch[0];
    
    // Extract GitHub
    const githubMatch = text.match(/(?:github\.com\/)[\w\-]+|(?:https?:\/\/)?(?:www\.)?github\.com\/[\w\-]+/i);
    if (githubMatch) data.github = githubMatch[0].startsWith('http') ? githubMatch[0] : 'https://' + githubMatch[0];
    
    // Extract website
    const websiteMatch = text.match(/(?:https?:\/\/)?(?:www\.)?[\w\-]+\.(?:com|net|org|io|dev|co)(?:\/[\w\-\.]*)?/i);
    if (websiteMatch && !websiteMatch[0].includes('linkedin') && !websiteMatch[0].includes('github')) {
        data.website = websiteMatch[0].startsWith('http') ? websiteMatch[0] : 'https://' + websiteMatch[0];
    }
    
    // Extract name (usually first line or first non-contact line)
    for (let i = 0; i < Math.min(5, lines.length); i++) {
        const line = lines[i];
        if (line.length > 3 && line.length < 50 && !line.includes('@') && !line.match(/\d{3}/) && 
            !line.toLowerCase().includes('curriculum') && !line.toLowerCase().includes('vitae')) {
            const words = line.split(/\s+/);
            if (words.length >= 2 && words.length <= 4) {
                data.fullName = line;
                break;
            }
        }
    }
    
    // Extract job title (often after name)
    const titlePatterns = [
        /(?:senior|junior|lead|principal|staff|chief)\s+\w+\s+(?:engineer|developer|manager|architect|designer|analyst)/i,
        /(?:software|web|full[\-\s]?stack|front[\-\s]?end|back[\-\s]?end|data|product|project)\s+(?:engineer|developer|manager|architect|designer|analyst)/i,
        /(?:engineer|developer|manager|architect|designer|analyst|specialist|consultant|coordinator)/i
    ];
    
    for (const line of lines.slice(0, 10)) {
        for (const pattern of titlePatterns) {
            if (pattern.test(line)) {
                data.jobTitle = line;
                break;
            }
        }
        if (data.jobTitle) break;
    }
    
    // Find section boundaries
    const sections = findSections(text);
    
    // Extract summary/profile
    if (sections.summary) {
        const summaryText = text.substring(sections.summary.start, sections.summary.end);
        const summaryLines = summaryText.split('\n').filter(l => l.trim().length > 20);
        data.summary = summaryLines.join(' ').substring(0, 1000);
    }
    
    // Extract skills
    if (sections.skills) {
        const skillsText = text.substring(sections.skills.start, sections.skills.end);
        data.skills = extractSkills(skillsText);
    }
    
    // Extract experience
    if (sections.experience) {
        const expText = text.substring(sections.experience.start, sections.experience.end);
        data.experiences = extractExperience(expText);
    }
    
    // Extract education
    if (sections.education) {
        const eduText = text.substring(sections.education.start, sections.education.end);
        data.education = extractEducation(eduText);
    }
    
    // Extract certifications
    if (sections.certifications) {
        const certText = text.substring(sections.certifications.start, sections.certifications.end);
        data.certifications = extractCertifications(certText);
    }
    
    // Extract languages
    if (sections.languages) {
        const langText = text.substring(sections.languages.start, sections.languages.end);
        data.languages = extractLanguages(langText);
    }
    
    return data;
}

function findSections(text) {
    const sections = {};
    const sectionPatterns = {
        summary: /(?:professional\s+)?(?:summary|profile|about|objective|overview)/i,
        experience: /(?:work\s+)?(?:experience|employment|professional\s+experience|career\s+history)/i,
        education: /education|academic|qualifications/i,
        skills: /(?:technical\s+)?skills|competencies|expertise/i,
        certifications: /certifications?|licenses?/i,
        languages: /languages?/i
    };
    
    const lines = text.split('\n');
    let currentPos = 0;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const lineStart = text.indexOf(lines[i], currentPos);
        currentPos = lineStart + lines[i].length;
        
        for (const [key, pattern] of Object.entries(sectionPatterns)) {
            if (pattern.test(line) && line.length < 50) {
                sections[key] = {start: lineStart};
                
                // Find end of this section (next section or end of doc)
                let endPos = text.length;
                for (let j = i + 1; j < lines.length; j++) {
                    const nextLine = lines[j].trim();
                    if (nextLine.length < 50) {
                        for (const otherPattern of Object.values(sectionPatterns)) {
                            if (otherPattern.test(nextLine)) {
                                endPos = text.indexOf(lines[j], currentPos);
                                break;
                            }
                        }
                    }
                    if (endPos < text.length) break;
                }
                sections[key].end = endPos;
            }
        }
    }
    
    return sections;
}

function extractSkills(text) {
    const skills = [];
    
    // Common skill patterns
    const skillSeparators = /[•\-\|,;]/g;
    const lines = text.split('\n');
    
    for (const line of lines) {
        const parts = line.split(skillSeparators).map(s => s.trim()).filter(s => s.length > 2 && s.length < 50);
        skills.push(...parts);
    }
    
    // Also try to extract from comma-separated list
    const commaSeparated = text.split(/[,;]/).map(s => s.trim()).filter(s => s.length > 2 && s.length < 50);
    skills.push(...commaSeparated);
    
    // Remove duplicates and clean
    return [...new Set(skills)].filter(s => !s.match(/^(skills?|technical|proficient|experience)$/i)).slice(0, 30);
}

function extractExperience(text) {
    const experiences = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    let currentExp = null;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Look for date patterns (indicates new job)
        const datePattern = /\b(20\d{2}|19\d{2})\b.*?(?:\b(20\d{2}|19\d{2})\b|present|current)/i;
        const monthYearPattern = /(?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s+\d{4}/i;
        
        if (datePattern.test(line) || monthYearPattern.test(line)) {
            // Save previous experience
            if (currentExp && currentExp.position) {
                experiences.push(currentExp);
            }
            
            // Start new experience
            currentExp = {
                id: expId++,
                position: '',
                company: '',
                location: '',
                startDate: '',
                endDate: '',
                current: false,
                responsibilities: []
            };
            
            // Extract dates
            const dates = line.match(datePattern);
            if (dates) {
                currentExp.startDate = dates[1] || '';
                currentExp.endDate = dates[2] || '';
                if (/present|current/i.test(line)) {
                    currentExp.current = true;
                    currentExp.endDate = 'Present';
                }
            }
            
            // Position is often the line before or after dates
            const prevLine = i > 0 ? lines[i - 1] : '';
            const nextLine = i < lines.length - 1 ? lines[i + 1] : '';
            
            if (prevLine.length > 5 && prevLine.length < 100 && !datePattern.test(prevLine)) {
                currentExp.position = prevLine;
            } else if (nextLine.length > 5 && nextLine.length < 100 && !datePattern.test(nextLine)) {
                currentExp.position = nextLine;
            }
        } else if (currentExp) {
            // Check if this is company name (often contains Inc, LLC, Ltd, etc)
            if (!currentExp.company && (line.includes('Inc') || line.includes('LLC') || line.includes('Ltd') || line.includes('Corp') || (line.length > 5 && line.length < 80))) {
                if (!currentExp.position || line !== currentExp.position) {
                    currentExp.company = line;
                }
            }
            // Check for bullet points (responsibilities)
            else if (line.startsWith('•') || line.startsWith('-') || line.startsWith('*') || line.match(/^[a-z]/i)) {
                const responsibility = line.replace(/^[•\-\*]\s*/, '').trim();
                if (responsibility.length > 10) {
                    currentExp.responsibilities.push(responsibility);
                }
            }
        }
    }
    
    // Add last experience
    if (currentExp && currentExp.position) {
        experiences.push(currentExp);
    }
    
    return experiences;
}

function extractEducation(text) {
    const education = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    const degreePatterns = /bachelor|master|ph\.?d|doctorate|associate|b\.?s\.?|m\.?s\.?|b\.?a\.?|m\.?a\.?|mba|diploma/i;
    
    let currentEdu = null;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Look for degree names
        if (degreePatterns.test(line)) {
            if (currentEdu && currentEdu.degree) {
                education.push(currentEdu);
            }
            
            currentEdu = {
                id: eduId++,
                degree: line,
                institution: '',
                location: '',
                year: '',
                gpa: '',
                thesis: ''
            };
            
            // Look for year in nearby lines
            const yearPattern = /\b(20\d{2}|19\d{2})\b/;
            for (let j = i; j < Math.min(i + 3, lines.length); j++) {
                const yearMatch = lines[j].match(yearPattern);
                if (yearMatch) {
                    currentEdu.year = yearMatch[1];
                    break;
                }
            }
            
            // Look for GPA
            const gpaPattern = /gpa:?\s*([\d\.]+)/i;
            for (let j = i; j < Math.min(i + 3, lines.length); j++) {
                const gpaMatch = lines[j].match(gpaPattern);
                if (gpaMatch) {
                    currentEdu.gpa = gpaMatch[1];
                    break;
                }
            }
        } else if (currentEdu && !currentEdu.institution) {
            // Next line after degree is often institution
            if (line.length > 5 && line.length < 150 && !line.match(/\d{4}/) && !degreePatterns.test(line)) {
                currentEdu.institution = line;
            }
        }
    }
    
    if (currentEdu && currentEdu.degree) {
        education.push(currentEdu);
    }
    
    return education;
}

function extractCertifications(text) {
    const certifications = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Skip section headers
        if (line.toLowerCase().includes('certification') && line.length < 30) continue;
        
        if (line.length > 10 && line.length < 200) {
            const cert = {
                id: certId++,
                name: line,
                issuer: '',
                date: '',
                credential: ''
            };
            
            // Look for year
            const yearMatch = line.match(/\b(20\d{2}|19\d{2})\b/);
            if (yearMatch) {
                cert.date = yearMatch[1];
            }
            
            // Look for issuer (often after a dash or comma)
            const parts = line.split(/[-–—,]/);
            if (parts.length > 1) {
                cert.name = parts[0].trim();
                cert.issuer = parts[1].trim();
            }
            
            certifications.push(cert);
        }
    }
    
    return certifications.slice(0, 10);
}

function extractLanguages(text) {
    const languages = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    const proficiencyPatterns = /(native|fluent|professional|advanced|intermediate|basic|beginner|working proficiency)/i;
    
    for (const line of lines) {
        // Skip section headers
        if (line.toLowerCase() === 'languages') continue;
        
        const profMatch = line.match(proficiencyPatterns);
        
        // Try to extract language and proficiency
        if (line.length > 3 && line.length < 100) {
            const parts = line.split(/[-–—:,]/);
            
            if (parts.length >= 2) {
                languages.push({
                    id: langId++,
                    name: parts[0].trim(),
                    proficiency: parts[1].trim()
                });
            } else if (profMatch) {
                const langName = line.replace(proficiencyPatterns, '').trim().replace(/^[•\-\*]\s*/, '');
                languages.push({
                    id: langId++,
                    name: langName,
                    proficiency: profMatch[1]
                });
            } else {
                // Just language name
                const langName = line.replace(/^[•\-\*]\s*/, '').trim();
                if (langName.length > 2 && langName.length < 30) {
                    languages.push({
                        id: langId++,
                        name: langName,
                        proficiency: 'Professional'
                    });
                }
            }
        }
    }
    
    return languages.slice(0, 10);
}

function displayExtractedData(data) {
    const preview = document.getElementById('importPreview');
    const extractedDataDiv = document.getElementById('extractedData');
    
    let html = '';
    
    if (data.fullName) {
        html += `<div class="import-field"><strong>Name:</strong> ${data.fullName}</div>`;
    }
    if (data.jobTitle) {
        html += `<div class="import-field"><strong>Job Title:</strong> ${data.jobTitle}</div>`;
    }
    if (data.email) {
        html += `<div class="import-field"><strong>Email:</strong> ${data.email}</div>`;
    }
    if (data.phone) {
        html += `<div class="import-field"><strong>Phone:</strong> ${data.phone}</div>`;
    }
    if (data.linkedin) {
        html += `<div class="import-field"><strong>LinkedIn:</strong> ${data.linkedin}</div>`;
    }
    if (data.github) {
        html += `<div class="import-field"><strong>GitHub:</strong> ${data.github}</div>`;
    }
    if (data.website) {
        html += `<div class="import-field"><strong>Website:</strong> ${data.website}</div>`;
    }
    if (data.summary) {
        html += `<div class="import-field"><strong>Summary:</strong> ${data.summary.substring(0, 200)}${data.summary.length > 200 ? '...' : ''}</div>`;
    }
    if (data.skills.length > 0) {
        html += `<div class="import-field"><strong>Skills (${data.skills.length}):</strong> ${data.skills.slice(0, 10).join(', ')}${data.skills.length > 10 ? '...' : ''}</div>`;
    }
    if (data.experiences.length > 0) {
        html += `<div class="import-field"><strong>Work Experience:</strong> ${data.experiences.length} position${data.experiences.length > 1 ? 's' : ''} found</div>`;
    }
    if (data.education.length > 0) {
        html += `<div class="import-field"><strong>Education:</strong> ${data.education.length} degree${data.education.length > 1 ? 's' : ''} found</div>`;
    }
    if (data.certifications.length > 0) {
        html += `<div class="import-field"><strong>Certifications:</strong> ${data.certifications.length} found</div>`;
    }
    if (data.languages.length > 0) {
        html += `<div class="import-field"><strong>Languages:</strong> ${data.languages.length} found</div>`;
    }
    
    if (!html) {
        html = '<p style="color:#999;text-align:center;padding:20px;">No data could be extracted. Please check your document format.</p>';
    }
    
    extractedDataDiv.innerHTML = html;
    preview.style.display = 'block';
}

function applyImportedData() {
    if (!importedData) {
        alert('No imported data available');
        return;
    }
    
    const data = importedData;
    
    // Populate basic info
    if (data.fullName) document.getElementById('fullName').value = data.fullName;
    if (data.jobTitle) document.getElementById('jobTitle').value = data.jobTitle;
    if (data.email) document.getElementById('email').value = data.email;
    if (data.phone) document.getElementById('phone').value = data.phone;
    if (data.linkedin) document.getElementById('linkedin').value = data.linkedin;
    if (data.github) document.getElementById('github').value = data.github;
    if (data.website) document.getElementById('website').value = data.website;
    if (data.summary) document.getElementById('summary').value = data.summary;
    
    // Populate skills
    skills = [...data.skills];
    renderSkills();
    
    // Populate experiences
    experiences = [...data.experiences];
    expId = experiences.length > 0 ? Math.max(...experiences.map(e => e.id)) + 1 : 0;
    renderExperiences();
    
    // Populate education
    education = [...data.education];
    eduId = education.length > 0 ? Math.max(...education.map(e => e.id)) + 1 : 0;
    renderEducation();
    
    // Populate certifications
    certifications = [...data.certifications];
    certId = certifications.length > 0 ? Math.max(...certifications.map(c => c.id)) + 1 : 0;
    renderCertifications();
    
    // Populate languages
    languages = [...data.languages];
    langId = languages.length > 0 ? Math.max(...languages.map(l => l.id)) + 1 : 0;
    renderLanguages();
    
    // Show success message and switch to basic tab
    alert('Your CV data has been imported successfully! Review the information in each section and make any necessary adjustments.');
    
    // Switch to basic info tab
    showTab('basic');
    
    // Scroll to top
    window.scrollTo({top: 0, behavior: 'smooth'});        <div class="nav-item" onclick="showTab('ats')">
            <i class="fas fa-robot"></i>
            <span>ATS Optimizer</span>
        </div>
        <div class="nav-item" onclick="showTab('import')">
            <i class="fas fa-file-import"></i>
            <span>Import CV</span>
        </div>
        
        <div class="score-card">
